select  TipoLinha,tipomov,VNDCONTACBL  ,ContPagCBL,Sum(VALOR) as Valor,id_VndCabdocumento,  DescricaoLinha ,ID_Documento,TipoDoc,Seriedoc,TipoOperacao,data,valortotal,Cliente,ContribuinteEntidade,ContaCblCliente ,mercado, Morada,Localidade,CodigoPostal,Telefone, ID_CodigoCliente,ID_ModoPagamento,subfamilia,taxaiva,case when isnull(V_perIVA.ID_VndCabDocumentoDev,0)>0 then CodigoExternoFPerIVA else ProdContCBL end as ProdContCBL,case when isnull(V_perIVA.ID_VndcabdocumentoDev,0)>0 then CodigoExternoIvaFPerIVA else IVACONTACBL end as IVACONTACBL,case when isnull(V_perIVA.ID_VndcabdocumentoDev,0)>0 then ClasseIVAFPerIVA else ClasseIVA end as ClasseIVA,case when isnull(V_perIVA.ID_VndcabdocumentoDev,0)>0 then CentroCustoFPerIVA else ContaCCusto end as ContaCCusto,case when isnull(V_perIVA.ID_VndcabdocumentoDev,0)>0 then ContaAnaliticaFPerIVA else ContaAnalitica end as ContaAnalitica from      (select 0 as TipoLinha,0 as tipomov,IMCTipoDocumentoVenda.CodigoDefeito as VNDCONTACBL, '' as ContPagCBL, CASE WHEN vndcabdocumento.IvaIncluido=1  then (VndLinhaDocumento.valor-VndLinhaDocumento.valoriva) else  VndLinhaDocumento.valor END As Valor, vndcabdocumento.id_VndCabdocumento, VndLinhaDocumento.id_Linha,VndLinhaDocumento.DescricaoProduto as DescricaoLinha,VndLinhaDocumento.DescricaoProduto as DescricaoLinha1 ,VndLinhaDocumento.ID_Documento,TipoDocVnd.Descricao as TipoDoc, Serievnd.abreviatura as Seriedoc, TipoDocVnd.TipoOperacao,VndCabdocumento.data,vndcabdocumento.valortotal, case when IMCTipoDocumentoVenda.NaturezaDoc='C' then IMCExportacaoProduto.codigoExterno else codigoExternoD end as ProdContCBL, case when IMCTipoDocumentoVenda.NaturezaDoc='C' then IMCExportacaoProduto.classeIVA else classeIVAD end as classeIVA, case when IMCTipoDocumentoVenda.NaturezaDoc='C' then IMCExportacaoProduto.codigoExternoIVA else codigoExternoIVAD end as IVACONTACBL, vndcabdocumento.nomeentidade+' '+ vndcabdocumento.apelidoEntidade as Cliente,vndcabdocumento.contribuinteentidade ,case when IMCTipoDocumentoVenda.NaturezaDoc='C' then IMCExportacaoProduto.ContaCCusto else ContaCCustoD end as ContaCCusto ,case when IMCTipoDocumentoVenda.NaturezaDoc='C' then IMCExportacaoProduto.ContaAnalitica else ContaAnaliticaD end as ContaAnalitica, vndcabdocumento.id_TipodocVnd  as ID_Tipodocumento, tab_cliente.contacbl as  ContaCblCliente, Vmor1 as morada,vlocalidade as localidade,VCPos+'-'+VRua as  codigoPostal,vtelf as telefone,vnume as  ID_CodigoCliente,9999 as ID_ModoPagamento ,CodigoExternoFPerIVA , CodigoExternoIvaFPerIVA, ClasseIVAFPerIVA , CentroCustoFPerIVA, ContaAnaliticaFPerIVA,TAB_SubFam.vdesc as subfamilia,isnull(tab_Pais.mercado,1) as Mercado, VndLinhaDocumento.percentagemiva as TAXAIVA from  wellsys.dbo.vndcabdocumento inner join  wellsys.dbo.Tab_cliente on Tab_cliente.vnume=vndcabdocumento.id_entidade left join  wellsys.dbo.tab_Pais on tab_Pais.icodi=Tab_cliente.IcodiPais inner join wellsys.dbo.VndLinhaDocumento on VndLinhaDocumento.id_VndCabdocumento=vndcabdocumento.ID_Vndcabdocumento inner join wellsys.dbo.TipodocVnd on TipodocVnd.id_TipodocVnd=vndcabdocumento.id_TipodocVnd inner join wellsys.dbo.SerieVnd on TipodocVnd.id_TipodocVnd=SerieVnd.id_TipodocVnd and SerieVnd.id_serievnd=vndcabdocumento.Id_serievnd inner join wellsys.dbo.IMCTipoDocumentoVenda on IMCTipoDocumentoVenda.ID_TipoDocVnd= vndcabdocumento.ID_TipoDocVnd  inner join wellsys.dbo.FntInterFaceCenExp   on IMCTipoDocumentoVenda.ID_InterFaceCenExp=FntInterFaceCenExp.ID_InterFaceCenExp  inner join wellsys.dbo.TAb_Produto on TAb_Produto.Vproduto= VndLinhaDocumento.ID_Produto  INNER JOIN wellsys.dbo.TAB_SubFam TAB_SubFam ON    TAB_PRODUTO.VSUBFAM = TAB_SubFam.VCodSubFam  INNER JOIN wellsys.dbo.TAB_Familia TAB_Familia ON  TAB_SubFam.VCodFam = TAB_Familia.VCodFam  INNER JOIN wellsys.dbo.Tab_GrFamiliar Tab_GrFamiliar ON  TAB_Familia.vCodGrFam = Tab_GrFamiliar.VCodGrFam  left join wellsys.dbo.IMCExportacaoProduto on IMCExportacaoProduto.ID_Codigo= TAb_Produto.vproduto and IMCExportacaoProduto.ID_InterfaceCenExp=FntInterFaceCenExp.ID_InterFaceCenExp and (IMCExportacaoProduto.mercado=1) Where VndCabdocumento.anulado=0  and IMCTipoDocumentoVenda.CodigoDefeito<>'' and TipoMovimento=0  and FntInterFaceCenExp.ID_InterFaceCenExp=4 and VndCabdocumento.ID_vndcabdocumento>112033 and VndCabdocumento.data>=CONVERT(DATETIME,'26-08-2021',105) and VndCabdocumento.data<=CONVERT(DATETIME,'19-08-2021',105) Union All  select 1 as TipoLinha,0 as tipomov,IMCTipoDocumentoVenda.CodigoDefeito as VNDCONTACBL, '' as ContPagCBL,  VndLinhaDocumento.ValorIVA as Valor ,vndcabdocumento.id_VndCabdocumento, VndLinhaDocumento.id_Linha,Tab_iva.Vdesc as DescricaoLinha,VndLinhaDocumento.DescricaoProduto as DescricaoLinha1 ,VndLinhaDocumento.ID_Documento,TipoDocVnd.Descricao as TipoDoc, Serievnd.abreviatura as Seriedoc, TipoDocVnd.TipoOperacao,VndCabdocumento.data,VndCabdocumento.valortotal, case when IMCTipoDocumentoVenda.NaturezaDoc='C' then IMCExportacaoProduto.codigoExterno else codigoExternoD end as ProdContCBL, case when IMCTipoDocumentoVenda.NaturezaDoc='C' then IMCExportacaoProduto.classeIVA else classeIVAD end as classeIVA, case when IMCTipoDocumentoVenda.NaturezaDoc='C' then IMCExportacaoProduto.codigoExternoIVA else codigoExternoIVAD end as IVACONTACBL, vndcabdocumento.nomeentidade+' '+ vndcabdocumento.apelidoEntidade as Cliente,vndcabdocumento.contribuinteentidade ,case when IMCTipoDocumentoVenda.NaturezaDoc='C' then IMCExportacaoProduto.ContaCCusto else ContaCCustoD end as ContaCCusto ,case when IMCTipoDocumentoVenda.NaturezaDoc='C' then IMCExportacaoProduto.ContaAnalitica else ContaAnaliticaD end as ContaAnalitica,vndcabdocumento.id_TipodocVnd  as ID_Tipodocumento, tab_cliente.contacbl as  ContaCblCliente, Vmor1 as morada,vlocalidade as localidade,VCPos+'-'+VRua as  codigoPostal,vtelf as telefone,vnume as  ID_CodigoCliente,0 as ID_ModoPagamento ,CodigoExternoFPerIVA , CodigoExternoIvaFPerIVA, ClasseIVAFPerIVA , CentroCustoFPerIVA, ContaAnaliticaFPerIVA,TAB_SubFam.vdesc as subfamilia,isnull(tab_Pais.mercado,1) as Mercado, VndLinhaDocumento.percentagemiva as TAXAIVA from  wellsys.dbo.vndcabdocumento inner join  wellsys.dbo.Tab_cliente on Tab_cliente.vnume=vndcabdocumento.id_entidade left join  wellsys.dbo.tab_Pais on tab_Pais.icodi=Tab_cliente.IcodiPais inner join  wellsys.dbo.VndLinhaDocumento on VndLinhaDocumento.id_VndCabdocumento=vndcabdocumento.ID_Vndcabdocumento inner join  wellsys.dbo.TipodocVnd on TipodocVnd.id_TipodocVnd=vndcabdocumento.id_TipodocVnd inner join  wellsys.dbo.SerieVnd on TipodocVnd.id_TipodocVnd=SerieVnd.id_TipodocVnd and SerieVnd.id_serievnd=vndcabdocumento.Id_serievnd inner Join  wellsys.dbo.tab_Iva on Tab_iva.vcodi=vndLinhadocumento.ID_Iva inner join  wellsys.dbo.IMCTipoDocumentoVenda on IMCTipoDocumentoVenda.ID_TipoDocVnd= vndcabdocumento.ID_TipoDocVnd  inner join wellsys.dbo.FntInterFaceCenExp   on IMCTipoDocumentoVenda.ID_InterFaceCenExp=FntInterFaceCenExp.ID_InterFaceCenExp  inner join  wellsys.dbo.TAb_Produto on TAb_Produto.Vproduto= VndLinhaDocumento.ID_Produto  INNER JOIN  wellsys.dbo.TAB_SubFam TAB_SubFam ON    TAB_PRODUTO.VSUBFAM = TAB_SubFam.VCodSubFam  INNER JOIN  wellsys.dbo.TAB_Familia TAB_Familia ON  TAB_SubFam.VCodFam = TAB_Familia.VCodFam INNER JOIN  wellsys.dbo.Tab_GrFamiliar Tab_GrFamiliar ON  TAB_Familia.vCodGrFam = Tab_GrFamiliar.VCodGrFam  left join  wellsys.dbo.IMCExportacaoProduto on IMCExportacaoProduto.ID_Codigo= TAb_Produto.vproduto and IMCExportacaoProduto.ID_InterfaceCenExp=FntInterFaceCenExp.ID_InterFaceCenExp and (IMCExportacaoProduto.mercado=1) Where VndCabdocumento.anulado=0  and IMCTipoDocumentoVenda.CodigoDefeito<>'' and TipoMovimento=0  and FntInterFaceCenExp.ID_InterFaceCenExp=4 and vndlinhadocumento.percentagemIVA<>0  and VndCabdocumento.ID_vndcabdocumento>112033 and VndCabdocumento.data>=CONVERT(DATETIME,'26-08-2021',105) and VndCabdocumento.data<=CONVERT(DATETIME,'19-08-2021',105) Union All  select 2 as TipoLinha,1 as tipomov,IMCTipoDocumentoVenda.CodigoDefeito as VNDCONTACBL, IMCMODoPagamento.CodigoEXterno as ContPagCBL, VndLinhaDocumento.Valor as Valor ,vndcabdocumento.id_VndCabdocumento,VndLinhaDocumento.id_Linha, VndLinhaDocumento.DescricaoProduto as DescricaoLinha, VndLinhaDocumento.DescricaoProduto as DescricaoLinha1 ,VndLinhaDocumento.ID_Documento,TipoDocVnd.Descricao as TipoDoc,  Serievnd.abreviatura as Seriedoc, TipoDocVnd.TipoOperacao,VndCabdocumento.data,VndCabdocumento.valortotal, '' as ProdContCBL,   '' as ClasseIVA , '' as IVACONTACBL, vndcabdocumento.nomeentidade+' '+ vndcabdocumento.apelidoEntidade as Cliente,vndcabdocumento.contribuinteentidade, '' as  ContaCCusto, '' as ContaAnalitica,vndcabdocumento.id_TipodocVnd  as ID_Tipodocumento, tab_cliente.contacbl as  ContaCblCliente, Vmor1 as morada,vlocalidade as localidade,VCPos+'-'+VRua as  codigoPostal,vtelf as telefone,vnume as  ID_CodigoCliente,IMCMODoPagamento.ID_ModoPagamento , ''CodigoExternoFPerIVA ,  ''CodigoExternoIvaFPerIVA, '' ClasseIVAFPerIVA ,  ''CentroCustoFPerIVA,  ''ContaAnaliticaFPerIVA,  '' as subfamilia,isnull(tab_Pais.mercado,1) as Mercado, VndLinhaDocumento.percentagemiva as TAXAIVA from  wellsys.dbo.vndcabdocumento inner join  wellsys.dbo.TAB_CLIENTE on TAB_CLIENTE.vnume=vndcabdocumento.ID_Entidade left join  wellsys.dbo.tab_Pais on tab_Pais.icodi=Tab_cliente.IcodiPais inner join  wellsys.dbo.VndLinhaDocumento on VndLinhaDocumento.id_VndCabdocumento=vndcabdocumento.ID_Vndcabdocumento inner join  wellsys.dbo.TipodocVnd on TipodocVnd.id_TipodocVnd=vndcabdocumento.id_TipodocVnd inner join  wellsys.dbo.SerieVnd on TipodocVnd.id_TipodocVnd=SerieVnd.id_TipodocVnd and SerieVnd.id_serievnd=vndcabdocumento.Id_serievnd inner join  wellsys.dbo.IMCTipoDocumentoVenda on IMCTipoDocumentoVenda.ID_TipoDocVnd= vndcabdocumento.ID_TipoDocVnd  inner join wellsys.dbo.FntInterFaceCenExp   on IMCTipoDocumentoVenda.ID_InterFaceCenExp=FntInterFaceCenExp.ID_InterFaceCenExp  left join  wellsys.dbo.IMCMODoPagamento on IMCMODoPagamento.ID_ModoPagamento= VndLinhaDocumento.ID_ModoPagamento and IMCMODoPagamento.ID_InterFaceCenExp= FntInterFaceCenExp.ID_InterFaceCenExp Where VndCabdocumento.anulado=0   and FntInterFaceCenExp.ID_InterFaceCenExp=4 and IMCTipoDocumentoVenda.CodigoDefeito<>'' and TipoMovimento=1 and ((TipoDocVnd.ligcc=1 and TipoDocVnd.LiqAutomatica=1) or (TipoDocVnd.ligcaixa=1)) and VndCabdocumento.ID_vndcabdocumento>112033 and VndCabdocumento.data>=CONVERT(DATETIME,'26-08-2021',105) and VndCabdocumento.data<=CONVERT(DATETIME,'19-08-2021',105) Union All  select 2 as TipoLinha,1 as tipomov,IMCTipoDocumentoVenda.CodigoDefeito as VNDCONTACBL, FntInterFaceCenExp.ContaCBLPagCC+Cast(isnull(tab_Pais.mercado,1) as varchar(3))+TAB_CLIENTE.ContaCBL as ContPagCBL, VndCabdocumento.ValorTotal as Valor ,vndcabdocumento.id_VndCabdocumento,9999 as id_Linha,'Conta Corrente' as  DescricaoLinha,'Conta Corrente' as DescricaoLinha1 ,VndCabdocumento.ID_Documento,TipoDocVnd.Descricao as TipoDoc, Serievnd.abreviatura as Seriedoc, TipoDocVnd.TipoOperacao,VndCabdocumento.data,VndCabdocumento.valortotal, '' as ProdContCBL,   '' as ClasseIVA , '' as IVACONTACBL, vndcabdocumento.nomeentidade+' '+ vndcabdocumento.apelidoEntidade as Cliente,vndcabdocumento.contribuinteentidade, '' as  ContaCCusto, '' as ContaAnalitica,vndcabdocumento.id_TipodocVnd  as ID_Tipodocumento, tab_cliente.contacbl as  ContaCblCliente, Vmor1 as morada,vlocalidade as localidade,VCPos+'-'+VRua as  codigoPostal,vtelf as telefone,vnume as  ID_CodigoCliente,0 as ID_ModoPagamento , ''CodigoExternoFPerIVA ,  ''CodigoExternoIvaFPerIVA, '' ClasseIVAFPerIVA ,  ''CentroCustoFPerIVA,  ''ContaAnaliticaFPerIVA,  '' as subfamilia,isnull(tab_Pais.mercado,1) as Mercado, 0 as TAXAIVA from  wellsys.dbo.vndcabdocumento inner join  wellsys.dbo.TAB_CLIENTE on TAB_CLIENTE.vnume=vndcabdocumento.ID_Entidade left join  wellsys.dbo.tab_Pais on tab_Pais.icodi=Tab_cliente.IcodiPais inner join  wellsys.dbo.TipodocVnd on TipodocVnd.id_TipodocVnd=vndcabdocumento.id_TipodocVnd inner join  wellsys.dbo.SerieVnd on TipodocVnd.id_TipodocVnd=SerieVnd.id_TipodocVnd and SerieVnd.id_serievnd=vndcabdocumento.Id_serievnd inner join wellsys.dbo.IMCTipoDocumentoVenda on IMCTipoDocumentoVenda.ID_TipoDocVnd= vndcabdocumento.ID_TipoDocVnd  inner join wellsys.dbo.FntInterFaceCenExp   on IMCTipoDocumentoVenda.ID_InterFaceCenExp=FntInterFaceCenExp.ID_InterFaceCenExp  Where VndCabdocumento.anulado=0   and FntInterFaceCenExp.ID_InterFaceCenExp=4 and IMCTipoDocumentoVenda.CodigoDefeito<>''  and TipoDocVnd.ligcc=1 and TipoDocVnd.LiqAutomatica=0 and VndCabdocumento.ID_vndcabdocumento>112033 and VndCabdocumento.data>=CONVERT(DATETIME,'26-08-2021',105) and VndCabdocumento.data<=CONVERT(DATETIME,'19-08-2021',105) ) as x  left join wellsys.dbo.V_NotasCreditoForaPeriodoIvaMensal as V_perIVA   on x.ID_Vndcabdocumento=V_perIVA.ID_VndcabdocumentoDev Group By id_VndCabdocumento,subfamilia,ID_Documento,cliente,contribuinteentidade,TipoDoc,Seriedoc,TipoOperacao, TipoLinha,tipomov,VNDCONTACBL,ProdContCBL,  IVACONTACBL,DescricaoLinha,DescricaoLinha1,ContPagCBL,data,classeiva,valortotal, ContaCCusto,ContaAnalitica, ContaCblCliente,Morada,Localidade,CodigoPostal,Telefone, ID_CodigoCliente,ID_ModoPagamento,isnull(V_perIVA.ID_VndCabDocumentoDev,0),CodigoExternoFPerIVA , CodigoExternoIvaFPerIVA, ClasseIVAFPerIVA , CentroCustoFPerIVA, ContaAnaliticaFPerIVA,Mercado,TaxaIva order by id_vndcabdocumento,tipomov,subfamilia,DescricaoLinha1, tipolinha,VNDCONTACBL,ProdContCBL, ContaCCusto,ContaAnalitica,taxaIVa
