select *  from (  select distinct R.Ref as ID_Interno, 1 as TipoLinha  ,r.mpehotel,S.ERPSerie as ContaCBlDoc,f.ref as Serie,   r.rechnr as ID_Documento,r.datum as data,r.kdnr  as ID_entidade,  isnull(k.fibudeb,' ')as ContaCBLCliente,r.sum_belast as totalbruto,0 as desFinc ,status = case r.void When 0 then 'N'          When 2 then  'N'          When 1 then  'A'          end,sig, '482' as Versao,k.vorname+' '+k.name1 as nomecliente,isnull(k.strasse,' ')as MoradaEntidade, isnull(k.ort,' ') as localidadeEntidade, isnull(k.plz,' ') as codigopostalentidade,isnull(k.vatno,' ')as ContribuinteEntidade,r.sum_zahl as totalpago, 0 as troco,  '' as ContaCblprod,'' as Descritivo,0 as Quant,0 as VAlorUnit,   '' as ContaCBLIVA,'0' as taxaiva,0 as VAlor,'1' as Armazem,    '' as CCusto,'' as CodIsencao,0 as PercDesconto,0 as DescontoValor,     '' as ContaCBLPAg,''  as DescricaoPagamento,0 as ID_ModoPagamento,0 as valoriva,F.Code,  '' as TipoArtigoERP , 'UN' as CodUnvenda  ,'UN' as UniVenda , 'UN' as CodUnBase  , 'UN' as  UniBase ,'1' as factorconversao    , '' as  AreaNegocio, '' as DescAreaNegocio,'0' as ID_GrupoFamilia,'' as  GrupoFamilia,'0' as ID_Familia,'' as  Familia,'0' as ID_SubFamilia,'' as  SubFamilia, N.codenr as ID_Pais, N.ADDINFO as PaisISO,N.land as DescPais,0 as RefL,r.datum as datamovimento ,  '' as ProductType,'' as TaxCountry,'' as tax_code,S.typedoc as invoicetype,  '' as Id_gruposervico,'' as ContaCBL,'' as payment_mechanism   FROM protel_vf.proteluser.rechhist R     inner join  protel_vf.proteluser.leisthis L      on L.fisccode=R.fisccode      and L.rechnr=R.rechnr      left join protel_vf.proteluser.fiscalcd F on r.fisccode=f.ref      left join protel_vf.proteluser.Kunden K on r.kdnr=K.kdnr      left join protel_vf.proteluser.natcode N on k.landkz=N.Codenr      left join protel_vf.proteluser.fiscalcdsaft S on r.fisccode=s.ref       left join protel_vf.proteluser.PortugueseInvoiceSigning_history P on r.rechnr = p.refrech and R.fisccode = p.refcodefisc      WHERE R.fisccode <> 0 and S.ERPexporta ='S' and  r.datum>=CONVERT(DATETIME,'01-07-2022',105) and  r.datum<=CONVERT(DATETIME,'31-12-2022',105) and r.mpehotel IN(1) Union ALL  select distinct  R.Ref as ID_Interno, 2 as TipoLinha ,r.mpehotel,S.ERPSerie as ContaCBlDoc,f.ref as Serie,   r.rechnr as ID_Documento,r.datum as data,r.kdnr  as ID_entidade,  isnull(k.fibudeb,' ')as ContaCBLCliente,r.sum_belast as totalbruto,0 as desFinc ,status = case r.void When 0 then 'N'          When 2 then  'N'          When 1 then  'A'          end,sig, '482' as Versao,k.vorname+' '+k.name1   as nomecliente,isnull(k.strasse,' ')as MoradaEntidade, isnull(k.ort,' ') as localidadeEntidade, isnull(k.plz,' ') as codigopostalentidade,isnull(k.vatno,' ')as ContribuinteEntidade,r.sum_zahl as totalpago, 0 as troco, case when l.article<=0 then  cast (U.Gvkonto as varchar(100)) collate Latin1_General_CI_AS  else  case when Id_produtosys> 0 then  cast (ArtSys.ContaCbl as varchar(100)) collate Latin1_General_CI_AS  else  cast (ArticlesPMSSYS.Gvkonto  as varchar(100)) collate Latin1_General_CI_AS  end end  as ContaCblprod , case when l.article<=0 then  U.bez else art.text end as Descritivo , L.anzahl as Quant,L.epreis as VAlorUnit, M.account as ContaCBLIVA,L.mwstsatz as taxaiva,(L.anzahl*L.epreis) as VAlor,'1' as Armazem, u.kst1 as CCusto,metacodes.short as CodIsencao,0 as PercDesconto,0 as DescontoValor,  '' as ContaCBLPAg,' '  as DescricaoPagamento ,0 as ID_ModoPagamento, ( l.epreis* L.anzahl)/(100+L.mwstsatz)*L.mwstsatz as valoriva,F.Code, U.kst1 as TipoArtigoERP, Case  when ArtSys.vproduto  is null then  'UN' else CodUnvenda end as CodUnvenda,  Case  when ArtSys.vproduto  is null then 'UN' else UniVenda end as UniVenda, Case  when ArtSys.vproduto  is null then 'UN' else CodUnBase end as CodUnBase, Case  when ArtSys.vproduto  is null then 'UN' else UniBase end as UniBase, Case  when ArtSys.vproduto  is null then '1' else factorconversao end as factorconversao,ERP_AreaNegocio.ContaERP as AreaNegocio, ERP_AreaNegocio.DescricaoArea as DescAreaNegocio,U.statgrp as  ID_GrupoFamilia,'' as  GrupoFamilia,Familia.hgnr as ID_Familia,Familia.gruppe as Familia,U.kto as ID_SubFamilia,U.Bez as  SubFamilia, N.codenr as ID_Pais, N.ADDINFO as PaisISO,N.land as DescPais,l.ref as RefL,l.datum as datamovimento, isnull(MCP.short,' ') as ProductType, (Select xvalue from protel_vf.proteluser.xsetup where xsection='ERP_interface' and xkey='TaxCountry' and mpehotel=1) as TaxCountry, M.kennz2 as tax_code,'' as invoicetype, isnull(MCG.short,'') as Id_gruposervico,	(select xvalue from protel_vf.proteluser.xsetup where xsection='ERP_interface' and xkey='Prefixo TOC' and mpehotel=0)+(select xvalue from protel_vf.proteluser.xsetup   where xsection='ERP_interface' and xkey='Prefixo TAA' and mpehotel=0) + isnull(TAAC.data,'') as ContaCBL, '' as payment_mechanism  from protel_vf.proteluser.leisthis L   Inner join protel_vf.proteluser.rechhist R on L.fisccode=R.fisccode  and L.rechnr=R.rechnr   left join protel_vf.proteluser.fiscalcdsaft S on r.fisccode=s.ref   left join protel_vf.proteluser.fiscalcd F on r.fisccode=f.ref  left join protel_vf.proteluser.Kunden K on r.kdnr=K.kdnr  left join protel_vf.proteluser.natcode N on k.landkz=N.Codenr left join protel_vf.proteluser.PortugueseInvoiceSigning_history P on r.rechnr = p.refrech and R.fisccode = p.refcodefisc left join protel_vf.proteluser.ukto U on (L.Ukto=U.ktonr) left join protel_vf.proteluser.hgruppen Familia on (familia.hgnr=U.hauptgrp) left join protel_vf.proteluser.mwst M on (L.vatno=M.Satznr) left join protel_vf.proteluser.metadata on L.ukto=metadata.ref and metadata.xkey='Motivo_isenção' and metadata.mpehotel=R.mpehotel left join protel_vf.proteluser.metacodes on metadata.data=metacodes.ref and metadata.xkey='Motivo_isenção' left join protel_vf.proteluser.Articles as Art on l.article=Art.ref  left join protel_vf.proteluser.ArticlesPMSSYS as ArticlesPMSSYS on ArticlesPMSSYS.ref=Art.ref  left join sysposvf.dbo.tab_produto as ArtSys on ArticlesPMSSYS.Id_ProdutoSYS=ArtSys.vproduto  left join sysposvf.dbo.V_ERPInterfaceProdUnidade  on V_ERPInterfaceProdUnidade.ID_Produto=ArtSys.vproduto left join erpvf.dbo.ERP_AreaNegocioContaLancPMS  on  erpvf.dbo.ERP_AreaNegocioContaLancPMS.KTONR=U.KTONR left join erpvf.dbo.ERP_AreaNegocio  on  ERP_AreaNegocio.ID_AreaNegocio=ERP_AreaNegocioContaLancPMS.ID_AreaNegocio left join (select ref,data from protel_vf.proteluser.metadata where type=5400 and xkey='TipoProdutoT') as TAAP on TAAP.ref=L.ukto  left join (select ref,data from protel_vf.proteluser.metadata where type=5400 and  xkey='gruposervico') as TAAG on TAAG.ref=L.ukto  left join (select ref,data from protel_vf.proteluser.metadata where type=5400 and  xkey='contacbl') as TAAC on TAAC.ref=L.ukto  left join protel_vf.proteluser.metacodes as MCP on MCP.ref=TAAP.data  left join protel_vf.proteluser.metacodes as MCG on MCG.ref=TAAG.data   WHERE (R.fisccode <> 0) and (S.ERPexporta ='S') and L.rkz=0 and L.article in (-1,0)  and  r.datum>=CONVERT(DATETIME,'01-07-2022',105) and  r.datum<=CONVERT(DATETIME,'31-12-2022',105) and r.mpehotel IN(1) Union All  select distinct  R.Ref as ID_Interno, 2 as TipoLinha ,r.mpehotel,S.ERPSerie as ContaCBlDoc,f.ref as Serie, r.rechnr as ID_Documento,r.datum as data,r.kdnr  as ID_entidade,  isnull(k.fibudeb,' ')as ContaCBLCliente,r.sum_belast as totalbruto,0 as desFinc ,status = case r.void When 0 then 'N' When 2 then  'N' When 1 then  'A' end,sig, '482' as Versao,k.vorname+' '+k.name1   as nomecliente,isnull(k.strasse,' ')as MoradaEntidade, isnull(k.ort,' ') as localidadeEntidade, isnull(k.plz,' ') as codigopostalentidade,isnull(k.vatno,' ')as ContribuinteEntidade,r.sum_zahl as totalpago, 0 as troco, case when l.article<=0 then   cast (U.Gvkonto as varchar(100)) collate Latin1_General_CI_AS  else  case when Id_produtosys> 0 then  cast (ArtSys.ContaCbl as varchar(100)) collate Latin1_General_CI_AS  else  cast (ArticlesPMSSYS.Gvkonto  as varchar(100)) collate Latin1_General_CI_AS  end end  as ContaCblprod  ,case when l.article<=0 then  U.bez else art.text end as Descritivo  ,L.anzahl as Quant,L.epreis as VAlorUnit, M.account as ContaCBLIVA,L.mwstsatz as taxaiva,(L.anzahl*L.epreis) as VAlor,'1' as Armazem, u.kst1 as CCusto,metacodes.short as CodIsencao,0 as PercDesconto,0 as DescontoValor,  '' as ContaCBLPAg,' '  as DescricaoPagamento ,0 as ID_ModoPagamento, ( l.epreis* L.anzahl)/(100+L.mwstsatz)*L.mwstsatz as valoriva,F.Code ,U.kst1 as TipoArtigoERP, Case  when ArtSys.vproduto  is null then  'UN' else CodUnvenda end as CodUnvenda,  Case  when ArtSys.vproduto  is null then 'UN' else UniVenda end as UniVenda, Case  when ArtSys.vproduto  is null then 'UN' else CodUnBase end as CodUnBase, Case  when ArtSys.vproduto  is null then 'UN' else UniBase end as UniBase, Case  when ArtSys.vproduto  is null then '1' else factorconversao end as factorconversao,ERP_AreaNegocio.ContaERP as AreaNegocio, ERP_AreaNegocio.DescricaoArea as DescAreaNegocio,U.statgrp as  ID_GrupoFamilia,'' as  GrupoFamilia,Familia.hgnr as ID_Familia,Familia.gruppe as Familia,U.kto as ID_SubFamilia,U.Bez as  SubFamilia, N.codenr as ID_Pais, N.ADDINFO as PaisISO,N.land as DescPais,l.ref as RefL,l.datum as datamovimento,isnull(AMPT.short,' ') as ProductType,(Select xvalue from protel_vf.proteluser.xsetup where xsection='ERP_interface' and xkey='TaxCountry' and mpehotel=1) as TaxCountry, M.kennz2 as tax_code,' ' as invoicetype,' ' as Id_gruposervico, (select xvalue from protel_vf.proteluser.xsetup where xsection='ERP_interface' and xkey='Prefixo TOC' and mpehotel=0)+case when (Select data from protel_vf.proteluser.metadata where type=5401 and xkey='contacblart' and ref=L.article) !='' then (select xvalue from protel_vf.proteluser.xsetup where xsection='ERP_interface' and xkey='Prefixo Artigos' and mpehotel=0)+ isnull(ACBL.data,'')  when exists (Select * from protel_vf.proteluser.metadata where type=5400 and xkey='contacbl' and ref=L.ukto) then (select xvalue from protel_vf.proteluser.xsetup where  xsection='ERP_interface' and xkey='Prefixo TAA' and mpehotel=0)+(select data from protel_vf.proteluser.metadata where type=5400 and  xkey='contacbl' and ref=L.ukto) else '' end as ContaCBL, '' as payment_mechanism  from protel_vf.proteluser.leisthis L   Inner join protel_vf.proteluser.rechhist R on L.fisccode=R.fisccode  and L.rechnr=R.rechnr   left join protel_vf.proteluser.fiscalcdsaft S on r.fisccode=s.ref   left join protel_vf.proteluser.fiscalcd F on r.fisccode=f.ref  left join protel_vf.proteluser.Kunden K on r.kdnr=K.kdnr  left join protel_vf.proteluser.natcode N on k.landkz=N.Codenr left join protel_vf.proteluser.PortugueseInvoiceSigning_history P on r.rechnr = p.refrech and R.fisccode = p.refcodefisc left join protel_vf.proteluser.ukto U on (L.Ukto=U.ktonr) left join protel_vf.proteluser.hgruppen Familia on (familia.hgnr=U.hauptgrp) left join protel_vf.proteluser.mwst M on (L.vatno=M.Satznr) left join protel_vf.proteluser.metadata on L.ukto=metadata.ref and metadata.xkey='Motivo_isenção' and metadata.mpehotel=R.mpehotel left join protel_vf.proteluser.metacodes on metadata.data=metacodes.ref and metadata.xkey='Motivo_isenção' left join protel_vf.proteluser.Articles as Art on l.article=Art.ref  left join protel_vf.proteluser.ArticlesPMSSYS as ArticlesPMSSYS on ArticlesPMSSYS.ref=Art.ref  left join sysposvf.dbo.tab_produto as ArtSys on ArticlesPMSSYS.Id_ProdutoSYS=ArtSys.vproduto  left join sysposvf.dbo.V_ERPInterfaceProdUnidade  on V_ERPInterfaceProdUnidade.ID_Produto=ArtSys.vproduto left join erpvf.dbo.ERP_AreaNegocioContaLancPMS  on  erpvf.dbo.ERP_AreaNegocioContaLancPMS.KTONR=U.KTONR left join erpvf.dbo.ERP_AreaNegocio  on  ERP_AreaNegocio.ID_AreaNegocio=ERP_AreaNegocioContaLancPMS.ID_AreaNegocio left join (select ref,data from protel_vf.proteluser.metadata where type=5401  and xkey='ProductTypeA') as APT on APT.ref=L.article left join (select ref,data from protel_vf.proteluser.metadata where type=5401  and xkey='contacblart') as ACBL on ACBL.ref=L.article left join protel_vf.proteluser.metacodes as AMPT on AMPT.ref=APT.data   WHERE (R.fisccode <> 0) and (S.ERPexporta ='S') and L.rkz=0 and L.article >0  and  r.datum>=CONVERT(DATETIME,'01-07-2022',105) and  r.datum<=CONVERT(DATETIME,'31-12-2022',105) and r.mpehotel IN(1) Union All  select R.Ref as ID_Interno, 3 as TipoLinha ,r.mpehotel,S.ERPSerie as ContaCBlDoc,f.ref as Serie, r.rechnr as ID_Documento,r.datum as data,r.kdnr as ID_entidade,  isnull(k.fibudeb,' ')as ContaCBLCliente,r.sum_belast as totalbruto,0 as desFinc ,status = case r.void When 0 then 'N'          When 2 then  'N'          When 1 then  'A'          end,sig, '482' as Versao,k.vorname+' '+k.name1  as nomecliente,isnull(k.strasse,' ')as MoradaEntidade, isnull(k.ort,' ') as localidadeEntidade, isnull(k.plz,' ') as codigopostalentidade,isnull(k.vatno,' ')as ContribuinteEntidade,r.sum_zahl as totalpago, 0 as troco, U.Gvkonto as ContaCblprod,U.bez as Descritivo,L.anzahl as Quant,L.epreis as VAlorUnit, M.account as ContaCBLIVA,L.mwstsatz as taxaiva,(L.anzahl*L.epreis) as VAlor,'1' as Armazem, u.kst1 as CCusto,metacodes.short as CodIsencao,0 as PercDesconto,0 as DescontoValor, Z.fibukto as ContaCBLPAg,Z.bez  as DescricaoPagamento,Z.zanr as ID_ModoPagamento, 0 as Valoriva,F.Code, U.kst1 as TipoArtigoERP, 'UN' as CodUnvenda  ,'UN' as UniVenda , 'UN' as CodUnBase  , 'UN' as  UniBase ,'1' as factorconversao    ,ERP_AreaNegocio.ContaERP as AreaNegocio, ERP_AreaNegocio.DescricaoArea as DescAreaNegocio,U.statgrp as  ID_GrupoFamilia,'' as  GrupoFamilia,Familia.hgnr as ID_Familia,Familia.gruppe as Familia,U.kto as ID_SubFamilia,U.Bez as  SubFamilia, N.codenr as ID_Pais, N.ADDINFO as PaisISO,N.land as DescPais ,l.ref as RefL ,l.datum as datamovimento,  '' as ProductType,'' as TaxCountry,'' as tax_code,'' as invoicetype,'' as Id_gruposervico, '' as ContaCBL,	isnull(MCBLP.short,'') as payment_mechanism  from protel_vf.proteluser.leisthis L Inner join protel_vf.proteluser.rechhist R on L.fisccode=R.fisccode and L.rechnr=R.rechnr left join protel_vf.proteluser.fiscalcdsaft S on r.fisccode=s.ref left join protel_vf.proteluser.fiscalcd F on r.fisccode=f.ref left join protel_vf.proteluser.Kunden K on r.kdnr=K.kdnr left join protel_vf.proteluser.natcode N on k.landkz=N.Codenr left join protel_vf.proteluser.PortugueseInvoiceSigning_history P on r.rechnr = p.refrech and R.fisccode = p.refcodefisc left join protel_vf.proteluser.ukto U on (L.Ukto=U.ktonr) left join protel_vf.proteluser.hgruppen Familia on (familia.hgnr=U.hauptgrp) left join protel_vf.proteluser.mwst M on (L.vatno=M.Satznr) left join protel_vf.proteluser.metadata on L.ukto=metadata.ref and metadata.xkey='Motivo_isenção' and metadata.mpehotel=R.mpehotel left join protel_vf.proteluser.metacodes on metadata.data=metacodes.ref and metadata.xkey='Motivo_isenção' inner join protel_vf.proteluser.zahlart as Z on Z.zanr=L.Rkz left join erpvf.dbo.ERP_AreaNegocioContaLancPMS  on  erpvf.dbo.ERP_AreaNegocioContaLancPMS.KTONR=U.KTONR left join erpvf.dbo.ERP_AreaNegocio  on  ERP_AreaNegocio.ID_AreaNegocio=ERP_AreaNegocioContaLancPMS.ID_AreaNegocio left join (select ref,data from protel_vf.proteluser.metadata where type=5100 and  xkey='ContaCBLPay') as CBLP on CBLP.ref=L.rkz   left join protel_vf.proteluser.metacodes as MCBLP on MCBLP.ref=CBLP.data   WHERE (R.fisccode <> 0) and (S.ERPexporta ='S') and L.rkz>0  and  r.datum>=CONVERT(DATETIME,'01-07-2022',105) and  r.datum<=CONVERT(DATETIME,'31-12-2022',105) and r.mpehotel IN(1)  )as x    where   isnull(x.serie,' ')<>''   and  x.data>=CONVERT(DATETIME,'01-07-2022',105) and  x.data<=CONVERT(DATETIME,'31-12-2022',105) and x.mpehotel IN(1)  order by id_interno,tipolinha
